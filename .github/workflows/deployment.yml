name: Deploy React Frontend to GCP VM

on:
  push:
    branches:
      - main
    paths:
      - "**.js"
      - "**.jsx"
      - "**.json"
      - "**.css"
      - "**.html"

jobs:
  build-and-deploy-vm:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    environment: vm-deploy
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          distribution: npm
          cache: npm

      - name: Install dependencies and Build React App
        run: |
          npm install
          npm run build

      - name: Archive build artifacts
        run: |
          tar -czf build.tar.gz -C dist .

      - name: Transfer frontend files to VM
        run: |
          echo "Transferring frontend build files..."
          gcloud compute scp build.tar.gz ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }}:/tmp/ --zone ${{ secrets.GCP_VM_ZONE }}

      - name: Deploy and configure frontend on VM
        run: |
          echo "Deploying frontend files..."
          gcloud compute ssh ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }} --zone ${{ secrets.GCP_VM_ZONE }} --command="
            sudo mkdir -p /var/www/frontend &&
            cd /tmp &&
            sudo tar -xzf build.tar.gz -C /var/www/frontend &&
            sudo chown -R www-data:www-data /var/www/frontend &&
            sudo chmod -R 755 /var/www/frontend &&
            echo 'Checking nginx service status...' &&
            if ! command -v nginx &> /dev/null; then
              echo 'Nginx not installed, installing...' &&
              sudo apt-get update &&
              sudo apt-get install -y nginx
            fi &&
            if sudo systemctl is-active --quiet nginx; then
              echo 'Nginx is running, reloading configuration...' &&
              sudo systemctl reload nginx
            else
              echo 'Nginx is not running, starting nginx...' &&
              sudo systemctl start nginx &&
              sudo systemctl enable nginx &&
              echo 'Nginx started and enabled'
            fi &&
            rm -f /tmp/build.tar.gz &&
            echo 'âœ… Frontend deployed successfully!'
          "
