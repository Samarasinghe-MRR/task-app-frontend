name: Phase 5 - CI/CD Frontend to GKE

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "public/**"
      - "**.js"
      - "**.jsx"
      - "**.json"
      - "**.css"
      - "**.html"
      - "Dockerfile"
      - "nginx.conf"
      - "k8s/**"

env:
  GCP_PROJECT_ID: dev-ops-475910
  GKE_CLUSTER: task-cluster
  GKE_ZONE: asia-south1-b
  ARTIFACT_REGISTRY_REGION: asia-south1
  REPOSITORY: task-repo-rajinie
  IMAGE_NAME: task-frontend
  NAMESPACE: task-api

jobs:
  build-push-deploy:
    name: Build, Push, and Deploy Frontend to GKE
    runs-on: ubuntu-latest
    environment: gke-deploy
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1. AUTHENTICATION & SDK SETUP ---
      - name: "Authenticate to GCP and Setup SDK"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Configure Docker to use gcloud as a credential helper"
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev

      # --- 2. BUILD REACT APPLICATION ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build React Application
        env:
          # Use relative path for GKE deployment (Ingress handles routing)
          VITE_API_BASE_URL: /api
        run: npm run build

      # --- 3. BUILD & PUSH DOCKER IMAGE ---
      - name: Build and Push Docker Image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_PATH="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          # Build image with both SHA tag and latest tag
          docker build -t $IMAGE_PATH:$IMAGE_TAG -t $IMAGE_PATH:latest .

          # Push both tags
          docker push $IMAGE_PATH:$IMAGE_TAG
          docker push $IMAGE_PATH:latest

      # --- 4. DEPLOY TO GKE ---
      - name: Set up GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check Prerequisites
        run: |
          echo "=== Checking if backend prerequisites exist ==="
          
          # Check if namespace exists
          if ! kubectl get namespace ${{ env.NAMESPACE }} > /dev/null 2>&1; then
            echo "❌ ERROR: Namespace '${{ env.NAMESPACE }}' does not exist!"
            echo "Please ensure backend has been deployed first to create shared infrastructure."
            exit 1
          fi
          
          # Check if backend service exists
          if ! kubectl get service backend-service -n ${{ env.NAMESPACE }} > /dev/null 2>&1; then
            echo "❌ ERROR: Backend service does not exist!"
            echo "Please ensure backend has been deployed first."
            exit 1
          fi
          
          echo "✅ Prerequisites check passed - backend infrastructure exists"

      - name: Update Kubernetes manifests and Deploy
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_PATH="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          # Create temporary deployment file with updated image
          sed "s|asia-south1-docker.pkg.dev/dev-ops-475910/task-repo-rajinie/task-frontend:latest|${IMAGE_PATH}:${IMAGE_TAG}|g" k8s/frontend-deployment.yaml > k8s/frontend-deployment-temp.yaml

          # Apply all necessary Kubernetes manifests
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/frontend-config.yaml
          kubectl apply -f k8s/frontend-deployment-temp.yaml
          kubectl apply -f k8s/frontend-service.yaml
          kubectl apply -f k8s/ingress.yaml

          # Clean up temporary file
          rm k8s/frontend-deployment-temp.yaml

      - name: Wait for Frontend Rollout
        run: |
          kubectl rollout status deployment/frontend-deployment -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Verify Deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=frontend
          echo "=== Service Status ==="
          kubectl get services -n ${{ env.NAMESPACE }}
          echo "=== Ingress Status ==="
          kubectl get ingress -n ${{ env.NAMESPACE }}
          echo "=== Recent Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=frontend --tail=10
